# 画像サイズ整数化 修正レポート

## 概要

商品一覧ページのカルーセル画像サイズが211.5pxのような小数値になっている問題を調査し、修正が必要な箇所を特定しました。

## 問題の原因

### 1. CSS Gridのサイズ計算

**現在の計算結果:**
- Grid幅: `430px`
- Gap: `7px`
- 列数: `2`
- 計算式: `(430 - 7) / 2 = 211.5px`

**問題箇所:**
- `.grid`要素の`gridTemplateColumns`が`211.5px 211.5px`になっている
- CSS変数`--gap`が`calc(16px)`と設定されているが、実際のgapは`7px`

### 2. JavaScriptでのサイズ計算

**ファイル:** `theme.js`（Shopifyテーマのメインスクリプト）  
**URL:** `https://www.thehwdogandco.com/cdn/shop/t/58/assets/theme.js`

## 修正が必要な箇所

### 1. `theme.js` - カルーセルの移動量計算（123行目付近）

**現在のコード:**
```javascript
const onMove = (e) => {
  if (!dragging) return;
  curX = (e.touches ? e.touches[0].clientX : e.clientX);
  const dx = curX - startX;
  const base = -index * gal.clientWidth;  // ← 問題: clientWidthが211.5px
  track.style.transform = `translateX(${base + dx}px)`;
};

const onEnd = () => {
  if (!dragging) return;
  dragging = false;
  const dx = curX - startX;
  const threshold = gal.clientWidth * 0.18;  // ← 問題: clientWidthが211.5px
  if (dx < -threshold && index < count - 1) index++;
  if (dx >  threshold && index > 0)       index--;
  track.style.transition = '';
  setActive(index);
};
```

**修正後:**
```javascript
const onMove = (e) => {
  if (!dragging) return;
  curX = (e.touches ? e.touches[0].clientX : e.clientX);
  const dx = curX - startX;
  const imageWidth = Math.round(gal.clientWidth);  // ← 整数に丸める
  const base = -index * imageWidth;
  track.style.transform = `translateX(${base + dx}px)`;
};

const onEnd = () => {
  if (!dragging) return;
  dragging = false;
  const dx = curX - startX;
  const imageWidth = Math.round(gal.clientWidth);  // ← 整数に丸める
  const threshold = imageWidth * 0.18;
  if (dx < -threshold && index < count - 1) index++;
  if (dx >  threshold && index > 0)       index--;
  track.style.transition = '';
  setActive(index);
};
```

### 2. `theme.js` - `setActive`関数（95行目付近）

**現在のコード:**
```javascript
const setActive = (i) => {
  track.style.transform = `translateX(-${i * 100}%)`;  // ← パーセンテージベース
  if (!dotsWrap) return;
  [...dotsWrap.children].forEach((d, di) => d.classList.toggle('is-active', di === i));
};
```

**修正後:**
```javascript
const setActive = (i) => {
  const imageWidth = Math.round(gal.clientWidth);  // ← 整数に丸める
  track.style.transform = `translateX(-${i * imageWidth}px)`;  // ← ピクセル値を使用
  if (!dotsWrap) return;
  [...dotsWrap.children].forEach((d, di) => d.classList.toggle('is-active', di === i));
};
```

### 3. CSS Gridのサイズ計算（`theme.css`）

**問題箇所:**
- `.grid`要素の`gridTemplateColumns`設定
- `--gap`変数の値（現在`calc(16px)`だが実際は`7px`）

**修正方法（オプション1 - Gapを調整）:**
```css
@media (max-width: 749px) {
  .grid {
    --gap: 6px; /* 7pxから6pxに変更 */
    /* これで (430 - 6) / 2 = 212px になる */
  }
}
```

**修正方法（オプション2 - Grid幅を調整）:**
```css
@media (max-width: 749px) {
  .grid {
    width: 432px; /* 430pxから432pxに変更 */
    /* これで (432 - 7) / 2 = 212.5px → 丸めて212px */
  }
}
```

## 修正の優先順位

### 優先度: 高
1. **`theme.js`の`gal.clientWidth`使用箇所**（123行目付近）
   - カルーセルの移動量計算に直接影響
   - `Math.round()`で整数化する

### 優先度: 中
2. **`theme.js`の`setActive`関数**（95行目付近）
   - パーセンテージからピクセル値に変更
   - 整数化した画像幅を使用

### 優先度: 低（オプション）
3. **CSS Gridのサイズ計算**
   - JavaScriptで整数化すれば、CSSの修正は不要
   - ただし、根本的な解決にはCSSの修正も検討

## 実装方法

### 方法1: JavaScriptで修正（推奨）

`theme.js`を修正するか、`assets/custom.js`に以下のコードを追加：

```javascript
// 既存のカルーセル初期化コードを上書き
document.addEventListener('DOMContentLoaded', function() {
  const galleries = document.querySelectorAll('[data-gallery]');
  
  galleries.forEach(gal => {
    const track = gal.querySelector('[data-track]');
    if (!track) return;
    
    // 既存のイベントリスナーを削除（必要に応じて）
    // 新しいイベントリスナーを追加
    
    let startX = 0, curX = 0, dragging = false, index = 0;
    const slides = gal.querySelectorAll('.card-gallery__img');
    const count = slides.length;
    
    const getImageWidth = () => Math.round(gal.clientWidth);  // 整数化
    
    const onStart = (e) => {
      dragging = true;
      startX = (e.touches ? e.touches[0].clientX : e.clientX);
      track.style.transition = 'none';
      curX = startX;
    };
    
    const onMove = (e) => {
      if (!dragging) return;
      curX = (e.touches ? e.touches[0].clientX : e.clientX);
      const dx = curX - startX;
      const imageWidth = getImageWidth();
      const base = -index * imageWidth;
      track.style.transform = `translateX(${base + dx}px)`;
    };
    
    const onEnd = () => {
      if (!dragging) return;
      dragging = false;
      const dx = curX - startX;
      const imageWidth = getImageWidth();
      const threshold = imageWidth * 0.18;
      if (dx < -threshold && index < count - 1) index++;
      if (dx >  threshold && index > 0)       index--;
      track.style.transition = '';
      setActive(index);
    };
    
    const setActive = (i) => {
      const imageWidth = getImageWidth();
      track.style.transform = `translateX(-${i * imageWidth}px)`;
    };
    
    track.addEventListener('touchstart', onStart, {passive:true});
    track.addEventListener('touchmove',  onMove,  {passive:true});
    track.addEventListener('touchend',  onEnd,   {passive:true});
  });
});
```

### 方法2: CSSで修正

`theme.css`またはカスタムCSSに以下を追加：

```css
@media (max-width: 749px) {
  .grid {
    --gap: 6px; /* 7pxから6pxに変更して整数化 */
  }
}
```

## 検証方法

修正後、以下を確認：

1. **画像サイズが整数になっているか**
   ```javascript
   const gal = document.querySelector('[data-gallery]');
   console.log(gal.clientWidth); // 212などの整数値であることを確認
   ```

2. **カルーセルの移動量が整数になっているか**
   ```javascript
   const track = document.querySelector('.card-gallery__track');
   const style = window.getComputedStyle(track);
   const transform = style.transform;
   // translateXの値が整数であることを確認
   ```

3. **スワイプ動作の確認**
   - 商品画像をスワイプして、移動量が画像幅の整数倍になっているか確認

## 関連ファイル

- **`theme.js`**: `https://www.thehwdogandco.com/cdn/shop/t/58/assets/theme.js`
- **`theme.css`**: `https://www.thehwdogandco.com/cdn/shop/t/58/assets/theme.css`
- **`xo-gallery.js`**: `https://cdn.shopify.com/extensions/.../xo-gallery.js`（カルーセルライブラリ）

## 注意事項

- `theme.js`はShopifyテーマのコアファイルのため、直接編集する場合はバックアップを取ること
- カスタマイズは`assets/custom.js`に追加することを推奨
- 修正後は複数のデバイスサイズで動作確認を行うこと

## 調査日

2025年12月27日

## 調査結果サマリー

- **総商品数**: 50個
- **現在の画像サイズ**: 211.5px（小数値）
- **目標画像サイズ**: 212px（整数値）
- **修正が必要なファイル**: `theme.js`（主に123行目付近、95行目付近）
- **修正方法**: `gal.clientWidth`を`Math.round(gal.clientWidth)`で整数化

