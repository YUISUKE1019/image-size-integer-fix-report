# 動的読み込み商品カルーセル初期化 - 実装レポート

## 概要

商品一覧ページで、スクロールなどによって動的に読み込まれた商品のカルーセルが正しく初期化されず、スクロール機能が動作しない問題を解決しました。

## 問題の詳細

### 発生していた問題

- **症状**: 動的に読み込まれた商品（例: DOG WATCH - Gray）のカルーセルで、track要素の幅が正しく設定されていない
- **影響**: カルーセルのスクロール機能が動作しない
- **確認された値**:
  - trackの幅: `194px`（1枚の画像の幅と同じ）
  - 期待される幅: `970px`（194px × 5枚）

### 問題の原因

**`theme.js`のカルーセル初期化処理が、ページ読み込み時に存在する要素に対してのみ実行されていたため。**

#### 原因の詳細分析

1. **初期化処理の実行タイミング**
   - `theme.js`の最後の方にある即時実行関数内で、`document.querySelectorAll('[data-gallery]')`で一度だけ要素を取得
   - ページ読み込み時に存在する要素に対してのみ初期化処理を実行
   - 動的に追加された要素に対しては初期化処理が実行されない

2. **trackの幅を設定している箇所**
   - `applyIntegerWidth`関数内で`track.style.width = ${imageWidth * count}px`を設定
   - この関数は`resyncWidths()`関数内で呼び出される
   - `resyncWidths()`は、初期化時、`resize`イベント時、画像の`load`イベント時に呼び出される

3. **動的読み込み商品への対応不足**
   - `MutationObserver`が設定されていない
   - スクロールで読み込まれた商品など、後から追加された商品に対して初期化処理が実行されない

## 解決方法

### 実装方針

**`MutationObserver`を使用して、動的に追加された`[data-gallery]`要素を監視し、自動的に初期化処理を実行する。**

### 実装内容

#### 1. MutationObserverの追加

`document.body`を監視し、動的に追加された要素を検出：

```javascript
function setupMutationObserver() {
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      mutation.addedNodes.forEach((node) => {
        // 追加されたノードが[data-gallery]要素の場合
        if (node.nodeType === 1 && node.matches && node.matches('[data-gallery]')) {
          setTimeout(() => {
            initializeCarousel(node);
          }, 0);
        }
        // 追加されたノードの子要素に[data-gallery]要素がある場合
        else if (node.nodeType === 1 && node.querySelectorAll) {
          const galleries = node.querySelectorAll('[data-gallery]');
          galleries.forEach(gal => {
            if (!initializedGalleries.has(gal)) {
              setTimeout(() => {
                initializeCarousel(gal);
              }, 0);
            }
          });
        }
      });
    });
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
}
```

#### 2. カルーセル初期化処理

`theme.js`の初期化処理と同じロジックを使用：

```javascript
function initializeCarousel(gal) {
  // 既に初期化済みの場合はスキップ
  if (initializedGalleries.has(gal)) {
    return;
  }

  const track = gal.querySelector('[data-track]');
  if (!track) return;

  const slides = gal.querySelectorAll('.card-gallery__img');
  const count = slides.length;

  if (count <= 1) {
    initializedGalleries.add(gal);
    return;
  }

  // 画像幅を整数値で設定
  const applyIntegerWidth = () => {
    const imageWidth = Math.round(gal.clientWidth);
    if (Number.isFinite(imageWidth) && imageWidth > 0) {
      track.style.width = `${imageWidth * count}px`;
      slides.forEach(slide => {
        slide.style.width = `${imageWidth}px`;
        slide.style.flex = `0 0 ${imageWidth}px`;
      });
    }
    return imageWidth;
  };

  // 初期化処理
  resyncWidths();
  // ... スワイプイベントハンドラの設定など
}
```

#### 3. 重複初期化の防止

`WeakSet`を使用して、既に初期化済みのカルーセルを追跡：

```javascript
const initializedGalleries = new WeakSet();

function initializeCarousel(gal) {
  if (initializedGalleries.has(gal)) {
    return;
  }
  // ... 初期化処理
  initializedGalleries.add(gal);
}
```

#### 4. 既存のカルーセルの初期化

ページ読み込み時に既に存在するカルーセルも初期化：

```javascript
function initializeExistingGalleries() {
  const galleries = document.querySelectorAll('[data-gallery]');
  galleries.forEach(gal => {
    if (!initializedGalleries.has(gal)) {
      initializeCarousel(gal);
    }
  });
}
```

## 実装ファイル

### ファイル名
`動的読み込み商品カルーセル初期化.js`

### 主な機能

1. **動的読み込み商品の検出**: `MutationObserver`で`[data-gallery]`要素の追加を監視
2. **自動初期化**: 検出時にカルーセル初期化処理を実行
3. **重複初期化の防止**: `WeakSet`で初期化済み要素を管理
4. **手動実行機能**: `window.initializeDynamicCarousels()`で手動実行可能

## 検証結果

### 検証環境
- URL: `https://www.thehwdogandco.com/collections/all-items`
- 対象商品: DOG WATCH - Gray

### 検証内容

1. **修正前の状態**
   - trackの幅: `194px`（1枚の画像の幅）
   - 期待される幅: `970px`（194px × 5枚）
   - 初期化状態: ❌ 未初期化

2. **修正後の状態**
   - trackの幅: `970px`
   - trackStyleWidth: `"970px"`
   - 初期化状態: ✅ 初期化済み

### 検証結果

```javascript
{
  product: "DOG WATCH - Gray",
  galleryWidth: 194,
  trackWidth: 970,
  trackStyleWidth: "970px",
  expectedWidth: 970,
  imageCount: 5,
  isInitialized: true,
  message: "✅ 初期化済み"
}
```

**結果**: 動的読み込み商品のカルーセルが正しく初期化され、スクロール機能が正常に動作することを確認しました。

## 適用方法

### 方法1: `assets/custom.js`に追加

`動的読み込み商品カルーセル初期化.js`の内容を`assets/custom.js`に追加します。

### 方法2: `theme.js`に統合

`theme.js`の最後の方にあるカルーセル初期化処理の後に、`MutationObserver`の設定を追加します。

### 方法3: 開発者ツールで手動実行

ブラウザの開発者ツールのコンソールで、以下のコードを実行：

```javascript
// コードを実行後、手動で再実行する場合
window.initializeDynamicCarousels();
```

## 技術的な詳細

### 使用している技術

1. **MutationObserver API**
   - DOMの変更を監視
   - `childList: true`で子要素の追加を監視
   - `subtree: true`で子孫要素も監視

2. **WeakSet**
   - 初期化済み要素の追跡
   - メモリリークを防ぐため、WeakSetを使用

3. **requestAnimationFrame**
   - レイアウト計算のタイミングを最適化
   - ブラウザのレンダリングサイクルに合わせて実行

### パフォーマンスへの配慮

1. **重複初期化の防止**: `WeakSet`で既に初期化済みの要素をスキップ
2. **非同期処理**: `setTimeout(() => {...}, 0)`でDOMの完全な構築を待つ
3. **イベントリスナーの最適化**: `passive: true`オプションでパフォーマンスを向上

## 今後の改善点

1. **PC画面でのスワイプ対応**: 現在はタッチデバイスのみ対応。PC画面でもマウスドラッグでスワイプできるようにする（`PC画面スワイプ対応_実装コード.js`を参照）

2. **エラーハンドリング**: 初期化処理でエラーが発生した場合の処理を追加

3. **ログ出力**: デバッグ用のログ出力を追加（本番環境では無効化）

## まとめ

動的読み込み商品に対するカルーセル初期化処理を実装し、以下の問題を解決しました：

- ✅ 動的に読み込まれた商品のカルーセルが正しく初期化される
- ✅ track要素の幅が正しく設定される
- ✅ カルーセルのスクロール機能が正常に動作する

この実装により、スクロールなどによって動的に読み込まれた商品でも、カルーセルが正しく動作するようになりました。
